!function(){var t=function(){this._sounds={},this._fades=[],this._contexts={},this._pool=[],this._update=this._update.bind(this),this._markLoaded=this._markLoaded.bind(this),this._playAfterLoadBound=this._playAfterLoad.bind(this)},n=t.prototype={},i=null;n._sounds=null,n._fades=null,n._pool=null,n.supportedSound=null,n._contexts=null;var s=0,e=1,o=2,a="CKSOUND";t.UNHANDLED="unhandled",t.init=function(n,s){i=new t,i.supportedSound=n,s&&i.loadConfig(s)},Object.defineProperty(t,"instance",{get:function(){return i}}),n.loadConfig=function(t,n){if(!t)return void Debug.warn("Warning - cloudkid.Sound was told to load a null config");var i=t.soundManifest,e=t.path;n=n||t.context;for(var o=0,a=i.length;a>o;++o){var u=i[o],l=this._sounds[u.id]={id:u.id,src:e+u.src+this.supportedSound,volume:u.volume?u.volume:1,state:s,playing:[],waitingToPlay:[],context:u.context||n,playAfterLoad:!1,preloadCallback:null};l.context&&(this._contexts[l.context]||(this._contexts[l.context]=new d(l.context)),this._contexts[l.context].sounds.push(l))}},n.exists=function(t){return!!this._sounds[t]},n.isUnloaded=function(t){return this._sounds[t]?this._sounds[t].state==s:!1},n.isLoaded=function(t){return this._sounds[t]?this._sounds[t].state==o:!1},n.isLoading=function(t){return this._sounds[t]?this._sounds[t].state==e:!1},n.isPlaying=function(t){var n=this._sounds[t];return n?n.playing.length+n.waitingToPlay.length>0:!1},n.fadeIn=function(t,n,i,s){var e,o;if("string"==typeof t){if(e=this._sounds[t],!e)return;e.playing.length&&(o=e.playing[e.playing.length-1])}else o=t,e=this._sounds[o.alias];if(o&&o._channel){o._fTime=0,o._fDur=n>0?n:500;var u=s>0?s:0;o._channel.setVolume(u),o.curVol=o._fStart=u,o._fEnd=i||e.volume,-1==this._fades.indexOf(o)&&(this._fades.push(o),1==this._fades.length&&cloudkid.OS.instance.addUpdateCallback(a,this._update))}},n.fadeOut=function(t,n,i,s){var e,o;if("string"==typeof t){if(e=this._sounds[t],!e)return;e.playing.length&&(o=e.playing[e.playing.length-1])}else o=t;o&&o._channel&&(o._fTime=0,o._fDur=n>0?n:500,s>0?(o._channel.setVolume(s),o._fStart=s):o._fStart=o._channel.getVolume(),o.curVol=o._fStart,o._fEnd=i||0,-1==this._fades.indexOf(o)&&(this._fades.push(o),1==this._fades.length&&cloudkid.OS.instance.addUpdateCallback(a,this._update)))},n._update=function(t){for(var n=this._fades,i=0,s=n.length-1;s>=0;--s){var e=n[s];if(!e.paused){var o=e._fTime+=t;if(o>=e._fDur){if(0===e._fEnd){var u=this._sounds[e.alias];u.playing=u.playing.splice(u.playing.indexOf(e),1),this._stopInst(e)}else e.curVol=e._fEnd,e.updateVolume();++i;var l=n.length-i;s!=l&&(n[s]=n[l])}else{var d,r=o/e._fDur;d=e._fEnd>e._fStart?e._fStart+(e._fEnd-e._fStart)*r:e._fEnd+(e._fStart-e._fEnd)*r,e.curVol=d,e.updateVolume()}}}n.length=n.length-i,0===n.length&&cloudkid.OS.instance.removeUpdateCallback(a)},n.play=function(n,i,a,u,l,d,r,h,c){if(l===!0&&(l=-1),h==t.UNHANDLED)return createjs.Sound.play(n,i,a,u,l,d,r);var _=this._sounds[n];if(!_)return Debug.error("cloudkid.Sound: sound "+n+" not found!"),void(h&&h());var p,f,g=_.state;if(d="number"==typeof d&&d>0?d:_.volume,g==o){var y=createjs.Sound.play(n,i,a,u,l,d,r);return y&&y.playState!=createjs.Sound.PLAY_FAILED?(p=this._getSoundInst(y,_.id),p.curVol=d,_.playing.push(p),p._endCallback=h,p.updateVolume(),p.length=y.getDuration(),p._channel.addEventListener("complete",p._endFunc),c&&setTimeout(c,0),p):(h&&h(),null)}return g==s?(_.state=e,_.playAfterLoad=!0,p=this._getSoundInst(null,_.id),p.curVol=d,_.waitingToPlay.push(p),p._endCallback=h,p._startFunc=c,p._startParams?(f=p._startParams,f[0]=i,f[1]=a,f[2]=u,f[3]=l,f[4]=r):p._startParams=[i,a,u,l,r],cloudkid.MediaLoader.instance.load(_.src,this._playAfterLoadBound,null,0,_),p):g==e?(_.playAfterLoad=!0,p=this._getSoundInst(null,_.id),p.curVol=d,_.waitingToPlay.push(p),p._endCallback=h,p._startFunc=c,p._startParams?(f=p._startParams,f[0]=i,f[1]=a,f[2]=u,f[3]=l,f[4]=r):p._startParams=[i,a,u,l,r],p):void 0},n._getSoundInst=function(t,n){var i;return this._pool.length?i=this._pool.pop():(i=new u,i._endFunc=this._onSoundComplete.bind(this,i)),i._channel=t,i.alias=n,i.length=t?t.getDuration():0,i},n._playAfterLoad=function(t){var n="string"==typeof t?t:t.id,i=this._sounds[n];if(i.state=o,i.playAfterLoad){for(var s=i.waitingToPlay,e=0;e<s.length;++e){var a=s[e],u=a._startParams,l=a.curVol,d=createjs.Sound.play(n,u[0],u[1],u[2],u[3],l,u[4]);d&&d.playState!=createjs.Sound.PLAY_FAILED?(i.playing.push(a),a._channel=d,a.length=d.getDuration(),a.updateVolume(),d.addEventListener("complete",a._endFunc),a._startFunc&&a._startFunc(),a.paused&&d.pause()):(a._endCallback&&a._endCallback(),this._poolInst(a))}s.length=0}},n._onSoundComplete=function(t){t._channel.removeEventListener("complete",t._endFunc);var n=this._sounds[t.alias];n.playing.splice(n.playing.indexOf(t),1);var i=t._endCallback;this._poolInst(t),i&&i()},n.stop=function(t){var n=this._sounds[t];if(n)if(n.playing.length)this._stopSound(n);else if(n.state==e){n.playAfterLoad=!1;for(var i=n.waitingToPlay,s=0;s<i.length;++s){var o=i[s];this._poolInst(o)}i.length=0}},n._stopSound=function(t){for(var n=t.playing,i=n.length-1;i>=0;--i)this._stopInst(n[i]);n.length=0},n._stopInst=function(t){t._channel.removeEventListener("complete",t._endFunc),t._channel.stop(),this._poolInst(t)},n.stopContext=function(t){if(t=this._contexts[t])for(var n=t.sounds,i=n.length-1;i>=0;--i){var s=n[i];s.playing.length?this._stopSound(s):s.state==e&&(s.playAfterLoad=!1)}},n.pauseSound=function(t){var n;n="string"==typeof t?this._sounds[t]:t;for(var i=n.playing,s=i.length-1;s>=0;--s)i[s].pause()},n.unpauseSound=function(t){var n;n="string"==typeof t?this._sounds[t]:t;for(var i=n.playing,s=i.length-1;s>=0;--s)i[s].unpause()},n.pauseAll=function(){var t=this._sounds;for(var n in t)this.pauseSound(t[n])},n.unpauseAll=function(){var t=this._sounds;for(var n in t)this.unpauseSound(t[n])},n.setContextMute=function(t,n){if(t=this._contexts[t]){t.muted=n;for(var i=t.volume,s=t.sounds,e=s.length-1;e>=0;--e){var o=s[e];if(o.playing.length)for(var a=o.playing,u=a.length-1;u>=0;--u)a[u].updateVolume(n?0:i)}}},n.setContextVolume=function(t,n){if(t=this._contexts[t]){var i=t.muted;t.volume=n;for(var s=t.sounds,e=s.length-1;e>=0;--e){var o=s[e];if(o.playing.length)for(var a=o.playing,u=a.length-1;u>=0;--u)a[u].updateVolume(i?0:n)}}},n.preloadSound=function(t,n){var i=this._sounds[t];return i?void(i.state==s&&(i.state=e,i.preloadCallback=n||null,cloudkid.MediaLoader.instance.load(i.src,this._markLoaded,null,0,i))):void Debug.error("Sound does not exist: "+t+" - can't preload!")},n.preload=function(t,n){if(!t||0===t.length)return void(n&&n());for(var i=[],o=0,a=t.length;a>o;++o){var u=this._sounds[t[o]];u?u.state==s&&(u.state=e,i.push(new cloudkid.LoadTask(u.id,u.src,this._markLoaded,null,0,u))):Debug.error("cloudkid.Sound was asked to preload "+t[o]+" but it is not a registered sound!")}if(i.length>0){var l=new cloudkid.TaskManager(i),d=function(){l.removeAllEventListeners(),l.destroy(),n&&n()};l.addEventListener(cloudkid.TaskManager.ALL_TASKS_DONE,d),l.startAll()}else n&&n()},n._markLoaded=function(t){var n=t.id,i=this._sounds[n];i&&(i.state=o,i.playAfterLoad&&this._playAfterLoad(n));var s=i.preloadCallback;s&&(i.preloadCallback=null,s())},n.createPreloadTask=function(t,n,i){return new l(t,n,i)},n.unload=function(t){if(t)for(var n=0,i=t.length;i>n;++n){var e=this._sounds[t[n]];e&&(this._stopSound(e),e.state=s),createjs.Sound.removeSound(t[n])}},n._poolInst=function(t){t._endCallback=null,t.alias=null,t._channel=null,t._startFunc=null,t.curVol=0,t.paused=!1,this._pool.push(t)},n.destroy=function(){i=null,this._volumes=null,this._fades=null,this._contexts=null,this._pool=null};var u=function(){this._channel=null,this._endFunc=null,this._endCallback=null,this._startFunc=null,this._startParams=null,this.alias=null,this._fTime=0,this._fDur=0,this._fStart=0,this._fEnd=0,this.curVol=0,this.length=0,this.paused=!1};Object.defineProperty(u.prototype,"position",{get:function(){return this._channel?this._channel.getPosition():0}}),u.prototype.stop=function(){var t=cloudkid.Sound.instance,n=t._sounds[this.alias];n.playing.splice(n.playing.indexOf(this),1),cloudkid.Sound.instance._stopInst(this)},u.prototype.updateVolume=function(n){if(this._channel){if(void 0===n){var i=t.instance,s=i._sounds[this.alias];if(s.context){var e=i._contexts[s.context];n=e.muted?0:e.volume}else n=1}this._channel.setVolume(n*this.curVol)}},u.prototype.pause=function(){this.paused||(this.paused=!0,this._channel&&this._channel.pause())},u.prototype.unpause=function(){this.paused&&(this.paused=!1,this._channel&&this._channel.resume())};var l=function(t,n,i){this.initialize(t,i),this.list=n};l.prototype=Object.create(cloudkid.Task.prototype),l.s=cloudkid.Task.prototype,l.prototype.start=function(t){i.preload(this.list,t)},l.prototype.destroy=function(){l.s.destroy.apply(this),this.list=null};var d=function(t){this.id=t,this.volume=1,this.muted=!1,this.sounds=[]};d.prototype={},namespace("cloudkid").Sound=t}(),function(){var t=function(t){this._audioListener=this._onAudioFinished.bind(this),this._update=this._update.bind(this),this._updateCaptionPos=this._updateCaptionPos.bind(this),t&&(this.captions=new cloudkid.Captions(null,!0)),this._listHelper=[]},n=t.prototype={};n.trackAudio=!1,n.audioList=null,n._listCounter=0,n._currentAudio=null,n._audioInst=null,n._callback=null,n._audioListener=null,n._playedAudio=null,n._timer=0,n.captions=null,n._listHelper=null,Object.defineProperty(n,"playing",{get:function(){return null!==this._currentAudio||this._timer>0}}),n.play=function(t,n){this.stop(),this._listCounter=-1,this._listHelper[0]=t,this.audioList=this._listHelper,this._callback=n,this._onAudioFinished()},n.playList=function(t,n){this.stop(),this._listCounter=-1,this.audioList=t,this._callback=n,this._onAudioFinished()},n._onAudioFinished=function(){if(cloudkid.OS.instance.removeUpdateCallback("VOPlayer"),this.captions&&this._audioInst&&this.captions.seek(this._audioInst.length),this._audioInst=null,this._listCounter++,this._listCounter>=this.audioList.length){this.captions&&this.captions.stop(),this._currentAudio=null;var t=this._callback;this._callback=null,t&&t()}else this._currentAudio=this.audioList[this._listCounter],"string"==typeof this._currentAudio?this._playAudio():"function"==typeof this._currentAudio?(this._currentAudio(),this._onAudioFinished()):(this._timer=this._currentAudio,this._currentAudio=null,cloudkid.OS.instance.addUpdateCallback("VOPlayer",this._update))},n._update=function(t){this.captions&&this.captions.updateTime(t),this._timer-=t,this._timer<=0&&this._onAudioFinished()},n._updateCaptionPos=function(){this._audioInst&&this.captions.seek(this._audioInst.position)},n._playAudio=function(){this.trackAudio&&(this._playedAudio?-1==this._playedAudio.indexOf(this._currentAudio)&&this._playedAudio.push(this._currentAudio):this._playedAudio=[this._currentAudio]);var t=cloudkid.Sound.instance;!t.exists(this._currentAudio)&&this.captions&&this.captions.hasCaption(this._currentAudio)?(this.captions.run(this._currentAudio),this._timer=this.captions.currentDuration,this._currentAudio=null,cloudkid.OS.instance.addUpdateCallback("VOPlayer",this._update)):(this._audioInst=t.play(this._currentAudio,null,null,null,null,null,null,this._audioListener),this.captions&&(this.captions.run(this._currentAudio),cloudkid.OS.instance.addUpdateCallback("VOPlayer",this._updateCaptionPos)));for(var n=this._listCounter+1;n<this.audioList.length;++n){var i=this.audioList[n];if("string"==typeof i){t.isLoaded(i)||t.preloadSound(i);break}}},n.stop=function(){this._currentAudio&&(cloudkid.Sound.instance.stop(this._currentAudio),this._currentAudio=null,this._callback=null),this.captions&&this.captions.stop(),cloudkid.OS.instance.removeUpdateCallback("VOPlayer"),this.audioList=null},n.unloadPlayedAudio=function(){cloudkid.Sound.instance.unload(this._playedAudio),this._playedAudio=null},n.destroy=function(){this.stop(),this.audioList=null,this._listHelper=null,this._currentAudio=null,this._audioInst=null,this._callback=null,this._audioListener=null,this._playedAudio=null,this.captions&&(this.captions.destroy(),this.captions=null)},namespace("cloudkid").VOPlayer=t}();