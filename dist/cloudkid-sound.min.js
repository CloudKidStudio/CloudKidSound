!function(){"use strict";var t=cloudkid.OS,n=cloudkid.MediaLoader,i=cloudkid.LoadTask,s=cloudkid.Task,e=cloudkid.TaskManager,a=function(){this._sounds={},this._fades=[],this._contexts={},this._pool=[],this._update=this._update.bind(this),this._markLoaded=this._markLoaded.bind(this),this._playAfterLoadBound=this._playAfterLoad.bind(this)},o=a.prototype={},u=null;o._sounds=null,o._fades=null,o._pool=null,o.supportedSound=null,o._contexts=null;var l=0,d=1,r=2,h="CKSOUND";a.UNHANDLED="unhandled",a.init=function(t,n){u=new a,u.supportedSound=t,n&&u.loadConfig(n)},Object.defineProperty(a,"instance",{get:function(){return u}}),o.loadConfig=function(t,n){if(!t)return void Debug.warn("Warning - cloudkid.Sound was told to load a null config");var i=t.soundManifest,s=t.path;n=n||t.context;for(var e=0,a=i.length;a>e;++e){var o=i[e],u=this._sounds[o.id]={id:o.id,src:s+o.src+this.supportedSound,volume:o.volume?o.volume:1,state:l,playing:[],waitingToPlay:[],context:o.context||n,playAfterLoad:!1,preloadCallback:null};u.context&&(this._contexts[u.context]||(this._contexts[u.context]=new _(u.context)),this._contexts[u.context].sounds.push(u))}},o.exists=function(t){return!!this._sounds[t]},o.isUnloaded=function(t){return this._sounds[t]?this._sounds[t].state==l:!1},o.isLoaded=function(t){return this._sounds[t]?this._sounds[t].state==r:!1},o.isLoading=function(t){return this._sounds[t]?this._sounds[t].state==d:!1},o.isPlaying=function(t){var n=this._sounds[t];return n?n.playing.length+n.waitingToPlay.length>0:!1},o.fadeIn=function(n,i,s,e){var a,o;if("string"==typeof n){if(a=this._sounds[n],!a)return;a.playing.length&&(o=a.playing[a.playing.length-1])}else o=n,a=this._sounds[o.alias];if(o&&o._channel){o._fTime=0,o._fDur=i>0?i:500;var u=e>0?e:0;o._channel.setVolume(u),o.curVol=o._fStart=u,o._fEnd=s||a.volume,-1==this._fades.indexOf(o)&&(this._fades.push(o),1==this._fades.length&&t.instance.addUpdateCallback(h,this._update))}},o.fadeOut=function(n,i,s,e){var a,o;if("string"==typeof n){if(a=this._sounds[n],!a)return;a.playing.length&&(o=a.playing[a.playing.length-1])}else o=n;o&&o._channel&&(o._fTime=0,o._fDur=i>0?i:500,e>0?(o._channel.setVolume(e),o._fStart=e):o._fStart=o._channel.getVolume(),o.curVol=o._fStart,o._fEnd=s||0,-1==this._fades.indexOf(o)&&(this._fades.push(o),1==this._fades.length&&t.instance.addUpdateCallback(h,this._update)))},o._update=function(n){for(var i=this._fades,s=0,e=i.length-1;e>=0;--e){var a=i[e];if(!a.paused){var o=a._fTime+=n;if(o>=a._fDur){if(0===a._fEnd){var u=this._sounds[a.alias];u.playing=u.playing.splice(u.playing.indexOf(a),1),this._stopInst(a)}else a.curVol=a._fEnd,a.updateVolume();++s;var l=i.length-s;e!=l&&(i[e]=i[l])}else{var d,r=o/a._fDur;d=a._fEnd>a._fStart?a._fStart+(a._fEnd-a._fStart)*r:a._fEnd+(a._fStart-a._fEnd)*r,a.curVol=d,a.updateVolume()}}}i.length=i.length-s,0===i.length&&t.instance.removeUpdateCallback(h)},o.play=function(t,i,s,e,o,u,h,c,p){if(h===!0&&(h=-1),i==a.UNHANDLED)return createjs.Sound.play(t,e,o,u,h,c,p);var _=this._sounds[t];if(!_)return Debug.error("cloudkid.Sound: sound "+t+" not found!"),void(i&&i());var f,g,y=_.state;if(c="number"==typeof c&&c>0?c:_.volume,y==r){var v=createjs.Sound.play(t,e,o,u,h,c,p);return v&&v.playState!=createjs.Sound.PLAY_FAILED?(f=this._getSoundInst(v,_.id),f.curVol=c,_.playing.push(f),f._endCallback=i,f.updateVolume(),f.length=v.getDuration(),f._channel.addEventListener("complete",f._endFunc),s&&setTimeout(s,0),f):(i&&i(),null)}return y==l?(_.state=d,_.playAfterLoad=!0,f=this._getSoundInst(null,_.id),f.curVol=c,_.waitingToPlay.push(f),f._endCallback=i,f._startFunc=s,f._startParams?(g=f._startParams,g[0]=e,g[1]=o,g[2]=u,g[3]=h,g[4]=p):f._startParams=[e,o,u,h,p],n.instance.load(_.src,this._playAfterLoadBound,null,0,_),f):y==d?(_.playAfterLoad=!0,f=this._getSoundInst(null,_.id),f.curVol=c,_.waitingToPlay.push(f),f._endCallback=i,f._startFunc=s,f._startParams?(g=f._startParams,g[0]=e,g[1]=o,g[2]=u,g[3]=h,g[4]=p):f._startParams=[e,o,u,h,p],f):void 0},o._getSoundInst=function(t,n){var i;return this._pool.length?i=this._pool.pop():(i=new c,i._endFunc=this._onSoundComplete.bind(this,i)),i._channel=t,i.alias=n,i.length=t?t.getDuration():0,i.isValid=!0,i},o._playAfterLoad=function(t){var n="string"==typeof t?t:t.id,i=this._sounds[n];if(i.state=r,i.playAfterLoad){for(var s=i.waitingToPlay,e=0;e<s.length;++e){var a=s[e],o=a._startParams,u=a.curVol,l=createjs.Sound.play(n,o[0],o[1],o[2],o[3],u,o[4]);l&&l.playState!=createjs.Sound.PLAY_FAILED?(i.playing.push(a),a._channel=l,a.length=l.getDuration(),a.updateVolume(),l.addEventListener("complete",a._endFunc),a._startFunc&&a._startFunc(),a.paused&&l.pause()):(a._endCallback&&a._endCallback(),this._poolInst(a))}s.length=0}},o._onSoundComplete=function(t){t._channel.removeEventListener("complete",t._endFunc);var n=this._sounds[t.alias];n.playing.splice(n.playing.indexOf(t),1);var i=t._endCallback;this._poolInst(t),i&&i()},o.stop=function(t){var n=this._sounds[t];if(n)if(n.playing.length)this._stopSound(n);else if(n.state==d){n.playAfterLoad=!1;for(var i=n.waitingToPlay,s=0;s<i.length;++s){var e=i[s];this._poolInst(e)}i.length=0}},o._stopSound=function(t){for(var n=t.playing,i=n.length-1;i>=0;--i)this._stopInst(n[i]);n.length=0},o._stopInst=function(t){t._channel.removeEventListener("complete",t._endFunc),t._channel.stop(),this._poolInst(t)},o.stopContext=function(t){if(t=this._contexts[t])for(var n=t.sounds,i=n.length-1;i>=0;--i){var s=n[i];s.playing.length?this._stopSound(s):s.state==d&&(s.playAfterLoad=!1)}},o.pauseSound=function(t){var n;n="string"==typeof t?this._sounds[t]:t;for(var i=n.playing,s=i.length-1;s>=0;--s)i[s].pause()},o.unpauseSound=function(t){var n;n="string"==typeof t?this._sounds[t]:t;for(var i=n.playing,s=i.length-1;s>=0;--s)i[s].unpause()},o.pauseAll=function(){var t=this._sounds;for(var n in t)this.pauseSound(t[n])},o.unpauseAll=function(){var t=this._sounds;for(var n in t)this.unpauseSound(t[n])},o.setContextMute=function(t,n){if(t=this._contexts[t]){t.muted=n;for(var i=t.volume,s=t.sounds,e=s.length-1;e>=0;--e){var a=s[e];if(a.playing.length)for(var o=a.playing,u=o.length-1;u>=0;--u)o[u].updateVolume(n?0:i)}}},o.setContextVolume=function(t,n){if(t=this._contexts[t]){var i=t.muted;t.volume=n;for(var s=t.sounds,e=s.length-1;e>=0;--e){var a=s[e];if(a.playing.length)for(var o=a.playing,u=o.length-1;u>=0;--u)o[u].updateVolume(i?0:n)}}},o.preloadSound=function(t,i){var s=this._sounds[t];return s?void(s.state==l&&(s.state=d,s.preloadCallback=i||null,n.instance.load(s.src,this._markLoaded,null,0,s))):void Debug.error("Sound does not exist: "+t+" - can't preload!")},o.preload=function(t,n){if(!t||0===t.length)return void(n&&n());for(var s=[],a=0,o=t.length;o>a;++a){var u=this._sounds[t[a]];u?u.state==l&&(u.state=d,s.push(new i(u.id,u.src,this._markLoaded,null,0,u))):Debug.error("cloudkid.Sound was asked to preload "+t[a]+" but it is not a registered sound!")}s.length>0?e.process(s,function(){n&&n()}):n&&n()},o._markLoaded=function(t){var n=t.id,i=this._sounds[n];i&&(i.state=r,i.playAfterLoad&&this._playAfterLoad(n));var s=i.preloadCallback;s&&(i.preloadCallback=null,s())},o.createPreloadTask=function(t,n,i){return new p(t,n,i)},o.unload=function(t){if(t)for(var n=0,i=t.length;i>n;++n){var s=this._sounds[t[n]];s&&(this._stopSound(s),s.state=l),createjs.Sound.removeSound(t[n])}},o._poolInst=function(t){t._endCallback=null,t.alias=null,t._channel=null,t._startFunc=null,t.curVol=0,t.paused=!1,t.isValid=!1,this._pool.push(t)},o.destroy=function(){u=null,this._volumes=null,this._fades=null,this._contexts=null,this._pool=null};var c=function(){this._channel=null,this._endFunc=null,this._endCallback=null,this._startFunc=null,this._startParams=null,this.alias=null,this._fTime=0,this._fDur=0,this._fStart=0,this._fEnd=0,this.curVol=0,this.length=0,this.paused=!1,this.isValid=!0};Object.defineProperty(c.prototype,"position",{get:function(){return this._channel?this._channel.getPosition():0}}),c.prototype.stop=function(){var t=a.instance,n=t._sounds[this.alias];n.playing.splice(n.playing.indexOf(this),1),a.instance._stopInst(this)},c.prototype.updateVolume=function(t){if(this._channel){if(void 0===t){var n=a.instance,i=n._sounds[this.alias];if(i.context){var s=n._contexts[i.context];t=s.muted?0:s.volume}else t=1}this._channel.setVolume(t*this.curVol)}},c.prototype.pause=function(){this.paused||(this.paused=!0,this._channel&&this._channel.pause())},c.prototype.unpause=function(){this.paused&&(this.paused=!1,this._channel&&this._channel.resume())};var p=function(t,n,i){this.initialize(t,i),this.list=n};p.prototype=Object.create(s.prototype),p.s=s.prototype,p.prototype.start=function(t){u.preload(this.list,t)},p.prototype.destroy=function(){p.s.destroy.apply(this),this.list=null};var _=function(t){this.id=t,this.volume=1,this.muted=!1,this.sounds=[]};_.prototype={},namespace("cloudkid").Sound=a}(),function(){"use strict";var t,n,i=cloudkid.Sound,s=function(i){t=cloudkid.Captions,n=cloudkid.OS,this._audioListener=this._onAudioFinished.bind(this),this._update=this._update.bind(this),this._updateCaptionPos=this._updateCaptionPos.bind(this),i&&(this.captions=i instanceof t?i:new t,this.captions.isSlave=!0),this._listHelper=[]},e=s.prototype={};e.trackAudio=!1,e.audioList=null,e._listCounter=0,e._currentAudio=null,e._audioInst=null,e._callback=null,e._audioListener=null,e._playedAudio=null,e._timer=0,e.captions=null,e._listHelper=null,Object.defineProperty(e,"playing",{get:function(){return null!==this._currentAudio||this._timer>0}}),e.play=function(t,n){this.stop(),this._listCounter=-1,this._listHelper[0]=t,this.audioList=this._listHelper,this._callback=n,this._onAudioFinished()},e.playList=function(t,n){this.stop(),this._listCounter=-1,this.audioList=t,this._callback=n,this._onAudioFinished()},e._onAudioFinished=function(){if(n.instance.removeUpdateCallback("VOPlayer"),this.captions&&this._audioInst&&this.captions.seek(this._audioInst.length),this._audioInst=null,this._listCounter++,this._listCounter>=this.audioList.length){this.captions&&this.captions.stop(),this._currentAudio=null;var t=this._callback;this._callback=null,t&&t()}else this._currentAudio=this.audioList[this._listCounter],"string"==typeof this._currentAudio?this._playAudio():"function"==typeof this._currentAudio?(this._currentAudio(),this._onAudioFinished()):(this._timer=this._currentAudio,this._currentAudio=null,n.instance.addUpdateCallback("VOPlayer",this._update))},e._update=function(t){this.captions&&this.captions.updateTime(t),this._timer-=t,this._timer<=0&&this._onAudioFinished()},e._updateCaptionPos=function(){this._audioInst&&this.captions.seek(this._audioInst.position)},e._playAudio=function(){this.trackAudio&&(this._playedAudio?-1==this._playedAudio.indexOf(this._currentAudio)&&this._playedAudio.push(this._currentAudio):this._playedAudio=[this._currentAudio]);var t=i.instance;!t.exists(this._currentAudio)&&this.captions&&this.captions.hasCaption(this._currentAudio)?(this.captions.play(this._currentAudio),this._timer=this.captions.currentDuration,this._currentAudio=null,n.instance.addUpdateCallback("VOPlayer",this._update)):(this._audioInst=t.play(this._currentAudio,this._audioListener),this.captions&&(this.captions.play(this._currentAudio),n.instance.addUpdateCallback("VOPlayer",this._updateCaptionPos)));for(var s=this._listCounter+1;s<this.audioList.length;++s){var e=this.audioList[s];if("string"==typeof e){t.isLoaded(e)||t.preloadSound(e);break}}},e.stop=function(){this._currentAudio&&(i.instance.stop(this._currentAudio),this._currentAudio=null,this._callback=null),this.captions&&this.captions.stop(),n.instance.removeUpdateCallback("VOPlayer"),this.audioList=null,this._timer=0},e.unloadPlayedAudio=function(){i.instance.unload(this._playedAudio),this._playedAudio=null},e.destroy=function(){this.stop(),this.audioList=null,this._listHelper=null,this._currentAudio=null,this._audioInst=null,this._callback=null,this._audioListener=null,this._playedAudio=null,this.captions&&(this.captions.destroy(),this.captions=null)},namespace("cloudkid").VOPlayer=s}();