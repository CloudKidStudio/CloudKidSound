!function(){"use strict";var t=cloudkid.OS,n=cloudkid.MediaLoader,i=cloudkid.LoadTask,s=cloudkid.Task,a=cloudkid.TaskManager,e=function(){this._sounds={},this._fades=[],this._contexts={},this._pool=[],this._update=this._update.bind(this),this._markLoaded=this._markLoaded.bind(this),this._playAfterLoadBound=this._playAfterLoad.bind(this)},o=e.prototype={},l=null;o._sounds=null,o._fades=null,o._pool=null,o.supportedSound=null,o._contexts=null;var u=0,d=1,r=2,h="CKSOUND";e.UNHANDLED="unhandled",e.init=function(t,n){l=new e,l.supportedSound=t,n&&l.loadConfig(n)},Object.defineProperty(e,"instance",{get:function(){return l}}),o.loadConfig=function(t,n){if(!t)return void Debug.warn("Warning - cloudkid.Sound was told to load a null config");var i=t.soundManifest,s=t.path;n=n||t.context;for(var a=0,e=i.length;e>a;++a){var o=i[a],l=this._sounds[o.id]={id:o.id,src:s+o.src+this.supportedSound,volume:o.volume?o.volume:1,state:u,playing:[],waitingToPlay:[],context:o.context||n,playAfterLoad:!1,preloadCallback:null,data:o};l.context&&(this._contexts[l.context]||(this._contexts[l.context]=new p(l.context)),this._contexts[l.context].sounds.push(l))}},o.exists=function(t){return!!this._sounds[t]},o.isUnloaded=function(t){return this._sounds[t]?this._sounds[t].state==u:!1},o.isLoaded=function(t){return this._sounds[t]?this._sounds[t].state==r:!1},o.isLoading=function(t){return this._sounds[t]?this._sounds[t].state==d:!1},o.isPlaying=function(t){var n=this._sounds[t];return n?n.playing.length+n.waitingToPlay.length>0:!1},o.fadeIn=function(n,i,s,a){var e,o;if("string"==typeof n){if(e=this._sounds[n],!e)return;e.playing.length&&(o=e.playing[e.playing.length-1])}else o=n,e=this._sounds[o.alias];if(o&&o._channel){o._fTime=0,o._fDur=i>0?i:500;var l=a>0?a:0;o._channel.setVolume(l),o.curVol=o._fStart=l,o._fEnd=s||e.volume,-1==this._fades.indexOf(o)&&(this._fades.push(o),1==this._fades.length&&t.instance.addUpdateCallback(h,this._update))}},o.fadeOut=function(n,i,s,a){var e,o;if("string"==typeof n){if(e=this._sounds[n],!e)return;e.playing.length&&(o=e.playing[e.playing.length-1])}else o=n;o&&o._channel&&(o._fTime=0,o._fDur=i>0?i:500,a>0?(o._channel.setVolume(a),o._fStart=a):o._fStart=o._channel.getVolume(),o.curVol=o._fStart,o._fEnd=s||0,-1==this._fades.indexOf(o)&&(this._fades.push(o),1==this._fades.length&&t.instance.addUpdateCallback(h,this._update)))},o._update=function(n){for(var i=this._fades,s=0,a=i.length-1;a>=0;--a){var e=i[a];if(!e.paused){var o=e._fTime+=n;if(o>=e._fDur){if(0===e._fEnd){var l=this._sounds[e.alias];l.playing=l.playing.splice(l.playing.indexOf(e),1),this._stopInst(e)}else e.curVol=e._fEnd,e.updateVolume();++s;var u=i.length-s;a!=u&&(i[a]=i[u])}else{var d,r=o/e._fDur;d=e._fEnd>e._fStart?e._fStart+(e._fEnd-e._fStart)*r:e._fEnd+(e._fStart-e._fEnd)*r,e.curVol=d,e.updateVolume()}}}i.length=i.length-s,0===i.length&&t.instance.removeUpdateCallback(h)},o.play=function(t,i,s,a,o,l,h,c,_){if(h===!0&&(h=-1),i==e.UNHANDLED)return createjs.Sound.play(t,a,o,l,h,c,_);var p=this._sounds[t];if(!p)return Debug.error("cloudkid.Sound: sound "+t+" not found!"),void(i&&i());var f,g,y=p.state;if(c="number"==typeof c&&c>0?c:p.volume,y==r){var v=createjs.Sound.play(t,a,o,l,h,c,_);return v&&v.playState!=createjs.Sound.PLAY_FAILED?(f=this._getSoundInst(v,p.id),v.handleExtraData&&v.handleExtraData(p.data),f.curVol=c,p.playing.push(f),f._endCallback=i,f.updateVolume(),f.length=v.getDuration(),f._channel.addEventListener("complete",f._endFunc),s&&setTimeout(s,0),f):(i&&i(),null)}return y==u?(p.state=d,p.playAfterLoad=!0,f=this._getSoundInst(null,p.id),f.curVol=c,p.waitingToPlay.push(f),f._endCallback=i,f._startFunc=s,f._startParams?(g=f._startParams,g[0]=a,g[1]=o,g[2]=l,g[3]=h,g[4]=_):f._startParams=[a,o,l,h,_],n.instance.load(p.src,this._playAfterLoadBound,null,0,p),f):y==d?(p.playAfterLoad=!0,f=this._getSoundInst(null,p.id),f.curVol=c,p.waitingToPlay.push(f),f._endCallback=i,f._startFunc=s,f._startParams?(g=f._startParams,g[0]=a,g[1]=o,g[2]=l,g[3]=h,g[4]=_):f._startParams=[a,o,l,h,_],f):void 0},o._getSoundInst=function(t,n){var i;return this._pool.length?i=this._pool.pop():(i=new c,i._endFunc=this._onSoundComplete.bind(this,i)),i._channel=t,i.alias=n,i.length=t?t.getDuration():0,i.isValid=!0,i},o._playAfterLoad=function(t){var n="string"==typeof t?t:t.id,i=this._sounds[n];if(i.state=r,i.playAfterLoad){for(var s=i.waitingToPlay,a=0;a<s.length;++a){var e=s[a],o=e._startParams,l=e.curVol,u=createjs.Sound.play(n,o[0],o[1],o[2],o[3],l,o[4]);u&&u.playState!=createjs.Sound.PLAY_FAILED?(i.playing.push(e),e._channel=u,u.handleExtraData&&u.handleExtraData(i.data),e.length=u.getDuration(),e.updateVolume(),u.addEventListener("complete",e._endFunc),e._startFunc&&e._startFunc(),e.paused&&u.pause()):(e._endCallback&&e._endCallback(),this._poolInst(e))}s.length=0}},o._onSoundComplete=function(t){t._channel.removeEventListener("complete",t._endFunc);var n=this._sounds[t.alias];n.playing.splice(n.playing.indexOf(t),1);var i=t._endCallback;this._poolInst(t),i&&i()},o.stop=function(t){var n=this._sounds[t];if(n)if(n.playing.length)this._stopSound(n);else if(n.state==d){n.playAfterLoad=!1;for(var i=n.waitingToPlay,s=0;s<i.length;++s){var a=i[s];this._poolInst(a)}i.length=0}},o._stopSound=function(t){for(var n=t.playing,i=n.length-1;i>=0;--i)this._stopInst(n[i]);n.length=0},o._stopInst=function(t){t._channel.removeEventListener("complete",t._endFunc),t._channel.stop(),this._poolInst(t)},o.stopContext=function(t){if(t=this._contexts[t])for(var n=t.sounds,i=n.length-1;i>=0;--i){var s=n[i];s.playing.length?this._stopSound(s):s.state==d&&(s.playAfterLoad=!1)}},o.pauseSound=function(t){var n;n="string"==typeof t?this._sounds[t]:t;for(var i=n.playing,s=i.length-1;s>=0;--s)i[s].pause()},o.unpauseSound=function(t){var n;n="string"==typeof t?this._sounds[t]:t;for(var i=n.playing,s=i.length-1;s>=0;--s)i[s].unpause()},o.pauseAll=function(){var t=this._sounds;for(var n in t)this.pauseSound(t[n])},o.unpauseAll=function(){var t=this._sounds;for(var n in t)this.unpauseSound(t[n])},o.setContextMute=function(t,n){if(t=this._contexts[t]){t.muted=n;for(var i=t.volume,s=t.sounds,a=s.length-1;a>=0;--a){var e=s[a];if(e.playing.length)for(var o=e.playing,l=o.length-1;l>=0;--l)o[l].updateVolume(n?0:i)}}},o.setContextVolume=function(t,n){if(t=this._contexts[t]){var i=t.muted;t.volume=n;for(var s=t.sounds,a=s.length-1;a>=0;--a){var e=s[a];if(e.playing.length)for(var o=e.playing,l=o.length-1;l>=0;--l)o[l].updateVolume(i?0:n)}}},o.preloadSound=function(t,i){var s=this._sounds[t];return s?void(s.state==u&&(s.state=d,s.preloadCallback=i||null,n.instance.load(s.src,this._markLoaded,null,0,s))):void Debug.error("Sound does not exist: "+t+" - can't preload!")},o.preload=function(t,n){if(!t||0===t.length)return void(n&&n());for(var s=[],e=0,o=t.length;o>e;++e){var l=this._sounds[t[e]];l?l.state==u&&(l.state=d,s.push(new i(l.id,l.src,this._markLoaded,null,0,l))):Debug.error("cloudkid.Sound was asked to preload "+t[e]+" but it is not a registered sound!")}s.length>0?a.process(s,function(){n&&n()}):n&&n()},o._markLoaded=function(t){var n=t.id,i=this._sounds[n];i&&(i.state=r,i.playAfterLoad&&this._playAfterLoad(n));var s=i.preloadCallback;s&&(i.preloadCallback=null,s())},o.createPreloadTask=function(t,n,i){return new _(t,n,i)},o.unload=function(t){if(t)for(var n=0,i=t.length;i>n;++n){var s=this._sounds[t[n]];s&&(this._stopSound(s),s.state=u),createjs.Sound.removeSound(t[n])}},o._poolInst=function(t){t._endCallback=null,t.alias=null,t._channel=null,t._startFunc=null,t.curVol=0,t.paused=!1,t.isValid=!1,this._pool.push(t)},o.destroy=function(){l=null,this._volumes=null,this._fades=null,this._contexts=null,this._pool=null};var c=function(){this._channel=null,this._endFunc=null,this._endCallback=null,this._startFunc=null,this._startParams=null,this.alias=null,this._fTime=0,this._fDur=0,this._fStart=0,this._fEnd=0,this.curVol=0,this.length=0,this.paused=!1,this.isValid=!0};Object.defineProperty(c.prototype,"position",{get:function(){return this._channel?this._channel.getPosition():0}}),c.prototype.stop=function(){var t=e.instance,n=t._sounds[this.alias];n.playing.splice(n.playing.indexOf(this),1),e.instance._stopInst(this)},c.prototype.updateVolume=function(t){if(this._channel){if(void 0===t){var n=e.instance,i=n._sounds[this.alias];if(i.context){var s=n._contexts[i.context];t=s.muted?0:s.volume}else t=1}this._channel.setVolume(t*this.curVol)}},c.prototype.pause=function(){this.paused||(this.paused=!0,this._channel&&this._channel.pause())},c.prototype.unpause=function(){this.paused&&(this.paused=!1,this._channel&&this._channel.resume())};var _=function(t,n,i){this.initialize(t,i),this.list=n};_.prototype=Object.create(s.prototype),_.s=s.prototype,_.prototype.start=function(t){l.preload(this.list,t)},_.prototype.destroy=function(){_.s.destroy.apply(this),this.list=null};var p=function(t){this.id=t,this.volume=1,this.muted=!1,this.sounds=[]};p.prototype={},namespace("cloudkid").Sound=e}(),function(){"use strict";var t,n,i=cloudkid.Sound,s=function(i){t=cloudkid.Captions,n=cloudkid.OS,this._audioListener=this._onAudioFinished.bind(this),this._update=this._update.bind(this),this._updateCaptionPos=this._updateCaptionPos.bind(this),i&&(this.captions=i instanceof t?i:new t,this.captions.isSlave=!0),this._listHelper=[]},a=s.prototype={};a.trackAudio=!1,a.audioList=null,a._listCounter=0,a._currentAudio=null,a._audioInst=null,a._callback=null,a._cancelledCallback=null,a._audioListener=null,a._playedAudio=null,a._timer=0,a.captions=null,a._listHelper=null,Object.defineProperty(a,"playing",{get:function(){return null!==this._currentAudio||this._timer>0}}),a.play=function(t,n,i){this.stop(),this._listCounter=-1,this._listHelper[0]=t,this.audioList=this._listHelper,this._callback=n,this._cancelledCallback=i,this._onAudioFinished()},a.playList=function(t,n,i){this.stop(),this._listCounter=-1,this.audioList=t,this._callback=n,this._cancelledCallback=i,this._onAudioFinished()},a._onAudioFinished=function(){if(n.instance.removeUpdateCallback("VOPlayer"),this.captions&&this._audioInst&&this.captions.seek(this._audioInst.length),this._audioInst=null,this._listCounter++,this._listCounter>=this.audioList.length){this.captions&&this.captions.stop(),this._currentAudio=null,this._cancelledCallback=null;var t=this._callback;this._callback=null,t&&t()}else this._currentAudio=this.audioList[this._listCounter],"string"==typeof this._currentAudio?this._playAudio():"function"==typeof this._currentAudio?(this._currentAudio(),this._onAudioFinished()):(this._timer=this._currentAudio,this._currentAudio=null,n.instance.addUpdateCallback("VOPlayer",this._update))},a._update=function(t){this.captions&&this.captions.updateTime(t),this._timer-=t,this._timer<=0&&this._onAudioFinished()},a._updateCaptionPos=function(){this._audioInst&&this.captions.seek(this._audioInst.position)},a._playAudio=function(){this.trackAudio&&(this._playedAudio?-1==this._playedAudio.indexOf(this._currentAudio)&&this._playedAudio.push(this._currentAudio):this._playedAudio=[this._currentAudio]);var t=i.instance;!t.exists(this._currentAudio)&&this.captions&&this.captions.hasCaption(this._currentAudio)?(this.captions.play(this._currentAudio),this._timer=this.captions.currentDuration,this._currentAudio=null,n.instance.addUpdateCallback("VOPlayer",this._update)):(this._audioInst=t.play(this._currentAudio,this._audioListener),this.captions&&(this.captions.play(this._currentAudio),n.instance.addUpdateCallback("VOPlayer",this._updateCaptionPos)));for(var s=this._listCounter+1;s<this.audioList.length;++s){var a=this.audioList[s];if("string"==typeof a){t.isLoaded(a)||t.preloadSound(a);break}}},a.stop=function(){this._currentAudio&&(i.instance.stop(this._currentAudio),this._currentAudio=null),this.captions&&this.captions.stop(),n.instance.removeUpdateCallback("VOPlayer"),this.audioList=null,this._timer=0,this._callback=null;var t=this._cancelledCallback;this._cancelledCallback=null,t&&t()},a.unloadPlayedAudio=function(){i.instance.unload(this._playedAudio),this._playedAudio=null},a.destroy=function(){this.stop(),this.audioList=null,this._listHelper=null,this._currentAudio=null,this._audioInst=null,this._callback=null,this._cancelledCallback=null,this._audioListener=null,this._playedAudio=null,this.captions&&(this.captions.destroy(),this.captions=null)},namespace("cloudkid").VOPlayer=s}();